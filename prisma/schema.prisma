// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// Seed script configuration
// Run with: npm run db:seed

enum UserRole {
  CLIENT
  RESTAURANT_OWNER
  RESTAURANT_EMPLOYEE
  DRIVER
  APP_EDITOR
  APP_OWNER
}

enum OrderStatus {
  PENDING
  ACCEPTED
  PREPARING
  READY
  ON_THE_WAY
  DELIVERED
  CANCELLED
  REFUNDED
}

enum PaymentMethod {
  CASH
  CARD_ONLINE
  CARD_COURIER
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
}

enum VehicleType {
  CAR
  BICYCLE
  SCOOTER
  FOOT
}

enum EmployeeRole {
  MANAGER
  CHEF
  WAITER
  COURIER
}

enum DiscountType {
  PERCENT
  FIXED
  DELIVERY_FREE
  GIFT
}

enum RecommendationReason {
  ORDER_HISTORY
  FAVORITES
  CUISINE_PREFERENCE
  POPULAR
  NEW
}

enum DriverOrderStatus {
  ASSIGNED
  ACCEPTED
  PICKED_UP
  DELIVERED
  CANCELLED
}

model User {
  id            Int       @id @default(autoincrement())
  email         String    @unique @db.VarChar(255)
  phone         String?   @unique @db.VarChar(20)
  name          String?   @db.VarChar(100)
  birthDate     DateTime? @map("birth_date") @db.Date
  passwordHash  String    @map("password_hash") @db.VarChar(255)
  role          UserRole  @default(CLIENT)
  avatarUrl     String?   @map("avatar_url") @db.VarChar(500)
  isActive      Boolean   @default(true) @map("is_active")
  createdAt     DateTime  @default(now()) @map("created_at")
  updatedAt     DateTime  @updatedAt @map("updated_at")

  addresses            Address[]
  sessions             UserSession[]
  ownedRestaurants     Restaurant[] @relation("RestaurantOwner")
  restaurantEmployees  RestaurantEmployee[]
  orders               Order[] @relation("OrderUser")
  driverOrders         Order[] @relation("OrderDriver")
  driverProfile        DriverProfile?
  cartItems            CartItem[]
  favorites            Favorite[]
  recommendations      Recommendation[]
  restaurantReviews    RestaurantReview[]
  dishReviews          DishReview[]

  @@index([email])
  @@index([phone])
  @@index([role])
  @@map("users")
}

model Address {
  id         Int       @id @default(autoincrement())
  userId     Int       @map("user_id")
  address    String    @db.Text
  city       String?   @db.VarChar(100)
  street     String?   @db.VarChar(255)
  house      String?   @db.VarChar(20)
  apartment  String?   @db.VarChar(20)
  entrance   String?   @db.VarChar(10)
  floor      String?   @db.VarChar(10)
  comment    String?   @db.Text
  isPrimary  Boolean   @default(false) @map("is_primary")
  latitude   Decimal?  @db.Decimal(10, 8)
  longitude  Decimal?  @db.Decimal(11, 8)
  createdAt  DateTime  @default(now()) @map("created_at")

  user   User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  orders Order[]

  @@map("addresses")
}

model UserSession {
  id           Int      @id @default(autoincrement())
  userId       Int      @map("user_id")
  sessionToken String   @unique @map("session_token") @db.VarChar(255)
  expiresAt    DateTime @map("expires_at")
  createdAt    DateTime @default(now()) @map("created_at")

  user User @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@map("user_sessions")
}

model City {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  isActive    Boolean   @default(true) @map("is_active")
  orderIndex  Int       @default(0) @map("order_index")
  createdAt   DateTime  @default(now()) @map("created_at")
  updatedAt   DateTime  @updatedAt @map("updated_at")

  restaurants RestaurantCity[]

  @@map("cities")
}

model Restaurant {
  id              Int       @id @default(autoincrement())
  ownerId         Int?      @map("owner_id")
  name            String    @db.VarChar(255)
  description     String?   @db.Text
  logoUrl         String?   @map("logo_url") @db.VarChar(500)
  coverUrl        String?   @map("cover_url") @db.VarChar(500)
  address         String    @db.Text
  phone           String?   @db.VarChar(20)
  email           String?   @db.VarChar(255)
  openingHours    Json?     @map("opening_hours")
  deliveryTime    Int?      @map("delivery_time")
  minOrderAmount  Decimal?  @map("min_order_amount") @db.Decimal(10, 2)
  deliveryFee     Decimal   @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  rating          Decimal   @default(0) @db.Decimal(3, 2)
  totalReviews    Int       @default(0) @map("total_reviews")
  isActive        Boolean   @default(true) @map("is_active")
  createdAt       DateTime  @default(now()) @map("created_at")
  updatedAt       DateTime  @updatedAt @map("updated_at")

  owner              User?                @relation("RestaurantOwner", fields: [ownerId], references: [id], onDelete: SetNull)
  cuisines           RestaurantCuisine[]
  categories         RestaurantCategory[]
  dishes             Dish[]
  orders             Order[]
  cartItems          CartItem[]
  employees          RestaurantEmployee[]
  reviews            RestaurantReview[]
  favorites          Favorite[]
  recommendations    Recommendation[]
  promotions         Promotion[]
  cities             RestaurantCity[]

  @@index([ownerId])
  @@index([rating(sort: Desc)])
  @@index([isActive])
  @@map("restaurants")
}

model RestaurantCity {
  id           Int        @id @default(autoincrement())
  restaurantId Int        @map("restaurant_id")
  cityId       Int        @map("city_id")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  city        City      @relation(fields: [cityId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, cityId])
  @@map("restaurant_cities")
}

model Cuisine {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  description String?   @db.Text
  iconUrl     String?   @map("icon_url") @db.VarChar(500)
  orderIndex  Int       @default(0) @map("order_index")
  isActive    Boolean   @default(true) @map("is_active")

  restaurants RestaurantCuisine[]

  @@map("cuisines")
}

model RestaurantCuisine {
  id           Int @id @default(autoincrement())
  restaurantId Int @map("restaurant_id")
  cuisineId    Int @map("cuisine_id")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  cuisine    Cuisine    @relation(fields: [cuisineId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, cuisineId])
  @@map("restaurant_cuisines")
}

model Category {
  id          Int       @id @default(autoincrement())
  name        String    @unique @db.VarChar(100)
  slug        String    @unique @db.VarChar(100)
  description String?   @db.Text
  iconUrl     String?   @map("icon_url") @db.VarChar(500)
  orderIndex  Int       @default(0) @map("order_index")
  isActive    Boolean   @default(true) @map("is_active")

  dishes              Dish[]
  restaurantCategories RestaurantCategory[]

  @@map("categories")
}

model RestaurantCategory {
  id           Int       @id @default(autoincrement())
  restaurantId Int       @map("restaurant_id")
  categoryId   Int?      @map("category_id")
  name         String    @db.VarChar(100)
  description  String?   @db.Text
  orderIndex   Int       @default(0) @map("order_index")
  isActive     Boolean   @default(true) @map("is_active")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category    Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  dishes      Dish[]

  @@unique([restaurantId, name])
  @@map("restaurant_categories")
}

model Dish {
  id                  Int       @id @default(autoincrement())
  restaurantId        Int       @map("restaurant_id")
  categoryId          Int?      @map("category_id")
  restaurantCategoryId Int?     @map("restaurant_category_id")
  name                String    @db.VarChar(255)
  description         String?   @db.Text
  price               Decimal   @db.Decimal(10, 2)
  discountPrice       Decimal?  @map("discount_price") @db.Decimal(10, 2)
  weight              String?   @db.VarChar(50)
  calories            Int?
  protein             Decimal?  @db.Decimal(5, 1)
  fat                 Decimal?  @db.Decimal(5, 1)
  carbs               Decimal?  @db.Decimal(5, 1)
  imageUrl            String[]  @map("image_url") @db.VarChar(500)
  cookingTime         Int?      @map("cooking_time")
  isAvailable         Boolean   @default(true) @map("is_available")
  isVegetarian        Boolean   @default(false) @map("is_vegetarian")
  isSpicy             Boolean   @default(false) @map("is_spicy")
  rating              Decimal   @default(0) @db.Decimal(3, 2)
  totalReviews        Int       @default(0) @map("total_reviews")
  orderIndex          Int       @default(0) @map("order_index")
  createdAt           DateTime  @default(now()) @map("created_at")
  updatedAt           DateTime  @updatedAt @map("updated_at")

  restaurant          Restaurant          @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  category            Category?           @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  restaurantCategory  RestaurantCategory? @relation(fields: [restaurantCategoryId], references: [id], onDelete: SetNull)
  cartItems           CartItem[]
  orderItems          OrderItem[]
  favorites           Favorite[]
  recommendations     Recommendation[]
  reviews             DishReview[]

  @@index([restaurantId])
  @@index([categoryId])
  @@index([isAvailable])
  @@index([price])
  @@index([rating(sort: Desc)])
  @@map("dishes")
}

model CartItem {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  dishId       Int       @map("dish_id")
  restaurantId Int       @map("restaurant_id")
  quantity     Int       @default(1)
  notes        String?   @db.Text
  createdAt    DateTime  @default(now()) @map("created_at")
  updatedAt    DateTime  @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dish       Dish       @relation(fields: [dishId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, dishId])
  @@map("cart_items")
}

model Order {
  id             Int           @id @default(autoincrement())
  orderNumber    String        @unique @map("order_number") @db.VarChar(50)
  userId         Int?          @map("user_id")
  restaurantId   Int?          @map("restaurant_id")
  driverId       Int?          @map("driver_id")
  addressId      Int?          @map("address_id")
  status         OrderStatus   @default(PENDING)
  paymentMethod  PaymentMethod @map("payment_method")
  paymentStatus  PaymentStatus @default(PENDING) @map("payment_status")
  totalAmount    Decimal       @map("total_amount") @db.Decimal(10, 2)
  deliveryFee    Decimal       @default(0) @map("delivery_fee") @db.Decimal(10, 2)
  discountAmount Decimal       @default(0) @map("discount_amount") @db.Decimal(10, 2)
  finalAmount    Decimal       @map("final_amount") @db.Decimal(10, 2)
  deliveryTime   DateTime?     @map("delivery_time")
  notes          String?       @db.Text
  cancelReason   String?       @map("cancel_reason") @db.Text
  createdAt      DateTime      @default(now()) @map("created_at")
  updatedAt      DateTime      @updatedAt @map("updated_at")

  user         User?         @relation("OrderUser", fields: [userId], references: [id], onDelete: SetNull)
  restaurant   Restaurant?   @relation(fields: [restaurantId], references: [id], onDelete: SetNull)
  driver       User?         @relation("OrderDriver", fields: [driverId], references: [id], onDelete: SetNull)
  address      Address?      @relation(fields: [addressId], references: [id], onDelete: SetNull)
  items        OrderItem[]
  driverOrders DriverOrder[]
  reviews      RestaurantReview[]
  dishReviews  DishReview[]

  @@index([userId])
  @@index([restaurantId])
  @@index([driverId])
  @@index([status])
  @@index([createdAt(sort: Desc)])
  @@map("orders")
}

model OrderItem {
  id         Int      @id @default(autoincrement())
  orderId    Int      @map("order_id")
  dishId     Int?     @map("dish_id")
  dishName   String   @map("dish_name") @db.VarChar(255)
  dishPrice  Decimal  @map("dish_price") @db.Decimal(10, 2)
  quantity   Int
  notes      String?  @db.Text
  totalPrice Decimal  @map("total_price") @db.Decimal(10, 2)

  order Order @relation(fields: [orderId], references: [id], onDelete: Cascade)
  dish  Dish? @relation(fields: [dishId], references: [id], onDelete: SetNull)

  @@map("order_items")
}

model RestaurantReview {
  id            Int      @id @default(autoincrement())
  userId        Int      @map("user_id")
  restaurantId  Int      @map("restaurant_id")
  orderId       Int?     @map("order_id")
  rating        Int
  comment       String?  @db.Text
  advantages    String[] @db.Text
  disadvantages String[] @db.Text
  imagesUrl     String[] @map("images_url") @db.VarChar(500)
  isVerified    Boolean  @default(false) @map("is_verified")
  isApproved    Boolean  @default(true) @map("is_approved")
  createdAt     DateTime @default(now()) @map("created_at")
  updatedAt     DateTime @updatedAt @map("updated_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  order      Order?     @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@unique([userId, restaurantId, orderId])
  @@index([restaurantId])
  @@map("restaurant_reviews")
}

model DishReview {
  id         Int      @id @default(autoincrement())
  userId     Int      @map("user_id")
  dishId     Int      @map("dish_id")
  orderId    Int?     @map("order_id")
  rating     Int
  comment    String?  @db.Text
  isVerified Boolean  @default(false) @map("is_verified")
  isApproved Boolean  @default(true) @map("is_approved")
  createdAt  DateTime @default(now()) @map("created_at")

  user  User   @relation(fields: [userId], references: [id], onDelete: Cascade)
  dish  Dish   @relation(fields: [dishId], references: [id], onDelete: Cascade)
  order Order? @relation(fields: [orderId], references: [id], onDelete: SetNull)

  @@unique([userId, dishId, orderId])
  @@index([dishId])
  @@map("dish_reviews")
}

model Favorite {
  id           Int       @id @default(autoincrement())
  userId       Int       @map("user_id")
  dishId       Int       @map("dish_id")
  restaurantId Int       @map("restaurant_id")
  createdAt    DateTime  @default(now()) @map("created_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dish       Dish       @relation(fields: [dishId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@unique([userId, dishId])
  @@map("favorites")
}

model Recommendation {
  id           Int                  @id @default(autoincrement())
  userId       Int                  @map("user_id")
  dishId       Int                  @map("dish_id")
  restaurantId Int                  @map("restaurant_id")
  score        Decimal              @db.Decimal(5, 4)
  reason       RecommendationReason
  createdAt    DateTime             @default(now()) @map("created_at")
  expiresAt    DateTime?            @map("expires_at")

  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)
  dish       Dish       @relation(fields: [dishId], references: [id], onDelete: Cascade)
  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)

  @@map("recommendations")
}

model Promotion {
  id              Int          @id @default(autoincrement())
  restaurantId    Int?         @map("restaurant_id")
  title           String       @db.VarChar(255)
  description     String?      @db.Text
  imageUrl        String?      @map("image_url") @db.VarChar(500)
  discountType    DiscountType @map("discount_type")
  discountValue   Decimal?     @map("discount_value") @db.Decimal(10, 2)
  minOrderAmount  Decimal?     @map("min_order_amount") @db.Decimal(10, 2)
  startDate       DateTime     @map("start_date")
  endDate         DateTime     @map("end_date")
  isActive        Boolean      @default(true) @map("is_active")
  createdAt       DateTime     @default(now()) @map("created_at")

  restaurant    Restaurant?      @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  promotionCodes PromotionCode[]

  @@map("promotions")
}

model PromotionCode {
  id          Int      @id @default(autoincrement())
  promotionId Int      @map("promotion_id")
  code        String   @unique @db.VarChar(50)
  maxUses     Int?     @map("max_uses")
  usedCount   Int      @default(0) @map("used_count")
  isActive    Boolean  @default(true) @map("is_active")
  createdAt   DateTime @default(now()) @map("created_at")

  promotion Promotion @relation(fields: [promotionId], references: [id], onDelete: Cascade)

  @@map("promotion_codes")
}

model DriverProfile {
  id                  Int          @id @default(autoincrement())
  userId              Int          @unique @map("user_id")
  vehicleType         VehicleType  @map("vehicle_type")
  vehicleNumber       String?      @map("vehicle_number") @db.VarChar(50)
  licensePlate        String?      @map("license_plate") @db.VarChar(20)
  documentsUrl        String[]     @map("documents_url") @db.VarChar(500)
  rating              Decimal      @default(0) @db.Decimal(3, 2)
  totalDeliveries     Int          @default(0) @map("total_deliveries")
  isAvailable         Boolean      @default(true) @map("is_available")
  currentLocationLat  Decimal?    @map("current_location_lat") @db.Decimal(10, 8)
  currentLocationLng  Decimal?    @map("current_location_lng") @db.Decimal(11, 8)
  lastOnlineAt        DateTime?    @map("last_online_at")
  createdAt           DateTime     @default(now()) @map("created_at")

  user        User         @relation(fields: [userId], references: [id], onDelete: Cascade)
  driverOrders DriverOrder[]

  @@map("driver_profiles")
}

model DriverOrder {
  id             Int              @id @default(autoincrement())
  driverId       Int              @map("driver_id")
  orderId        Int              @unique @map("order_id")
  assignedAt     DateTime         @default(now()) @map("assigned_at")
  acceptedAt     DateTime?        @map("accepted_at")
  pickedUpAt     DateTime?        @map("picked_up_at")
  deliveredAt    DateTime?        @map("delivered_at")
  status         DriverOrderStatus @default(ASSIGNED)
  cancelledReason String?         @map("cancelled_reason") @db.Text

  driver DriverProfile @relation(fields: [driverId], references: [id], onDelete: Cascade)
  order  Order         @relation(fields: [orderId], references: [id], onDelete: Cascade)

  @@map("driver_orders")
}

model RestaurantEmployee {
  id           Int          @id @default(autoincrement())
  restaurantId Int          @map("restaurant_id")
  userId       Int          @map("user_id")
  role         EmployeeRole
  permissions  Json?
  invitedBy    Int?         @map("invited_by")
  invitedAt    DateTime     @default(now()) @map("invited_at")
  acceptedAt   DateTime?    @map("accepted_at")
  isActive     Boolean      @default(true) @map("is_active")

  restaurant Restaurant @relation(fields: [restaurantId], references: [id], onDelete: Cascade)
  user       User       @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([restaurantId, userId])
  @@map("restaurant_employees")
}

